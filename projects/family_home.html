<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single Family Home Ownership Projection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* Define the Inter font and global styles */
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom number input styling */
        .input-group input[type="number"], .input-group select {
            border: 1px solid #d1d5db;
            padding: 8px;
            border-radius: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input[type="number"]:focus, .input-group select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f0f0f0; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3730a3; }
        
        /* Ensures chart area expands vertically within its container */
        .chart-container {
            position: relative;
            width: 100%;
            padding-bottom: 75%; /* Aspect ratio 4:3 */
        }
        .chart-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
        tailwind.config = {
            theme: { 
                extend: {
                    colors: {
                        'primary-blue': '#4f46e5',
                        'secondary-gray': '#f3f4f6',
                        'cost-red': '#ef4444', 
                        'paydown-blue': '#3b82f6',
                        'appreciation-purple': '#8b5cf6',
                        'equity-yellow': '#facc15',
                        'tax-pink': '#ec4899',
                        'irr-orange': '#f97316', 
                        // Removed 'opportunity-green': '#10b981',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-secondary-gray min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-6 md:mb-8">
            <h1 class="text-3xl font-extrabold text-primary-blue sm:text-4xl">Single Family Home Ownership Projection</h1>
            <p class="mt-2 text-md text-gray-600">Analyze the costs, equity growth, and total return on equity (ROE) for a primary residence.</p>
        </header>

        <main class="space-y-6 lg:space-y-8">
            
            <div id="controls" class="p-4 sm:p-6 bg-white shadow-xl rounded-xl border border-gray-100">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Assumptions & Inputs</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 space-y-0">
                    
                    <div class="space-y-4 p-4 border rounded-lg bg-blue-50">
                        <h3 class="font-bold text-lg text-primary-blue">Property Details</h3>
                        
                        <div class="input-group">
                            <label for="purchasePrice" class="block text-sm font-medium text-gray-700">Purchase Price ($):</label>
                            <input type="number" id="purchasePrice" value="700000" min="100000" step="10000" class="w-full mt-1">
                        </div>

                        <div class="input-group">
                            <label for="appreciation" class="block text-sm font-medium text-gray-700">Annual Appreciation (%):</label>
                            <input type="number" id="appreciation" value="4.0" min="0.0" max="10.0" step="0.1" class="w-full mt-1">
                            <p class="text-xs text-gray-500 mt-1">Expected annual growth in home value.</p>
                        </div>
                    </div>

                    <div class="space-y-4 p-4 border rounded-lg bg-green-50">
                        <h3 class="font-bold text-lg text-paydown-blue">Financing Details</h3> <div class="input-group">
                            <label for="downPayment" class="block text-sm font-medium text-gray-700">Down Payment (%):</label>
                            <input type="number" id="downPayment" value="20" min="3" max="50" step="1" class="w-full mt-1">
                        </div>

                        <div class="input-group">
                            <label for="loanTerm" class="block text-sm font-medium text-gray-700">Loan Term (Years):</label>
                            <input type="number" id="loanTerm" value="30" min="10" max="40" step="1" class="w-full mt-1">
                        </div>

                        <div class="input-group">
                            <label for="interestRate" class="block text-sm font-medium text-gray-700">Interest Rate (%):</label>
                            <input type="number" id="interestRate" value="6.50" min="2.00" max="10.00" step="0.01" class="w-full mt-1">
                        </div>
                        
                        <div class="input-group">
                            <label for="pmi" class="block text-sm font-medium text-gray-700">Monthly PMI ($) (If DP &lt; 20%):</label>
                            <input type="number" id="pmi" value="150" min="0" max="1000" step="10" class="w-full mt-1">
                            <p class="text-xs text-gray-500 mt-1">Ignored once loan-to-value drops below 80%.</p>
                        </div>
                    </div>

                    <div class="space-y-4 p-4 border rounded-lg bg-red-50">
                        <h3 class="font-bold text-lg text-cost-red">Annual Consumed Costs & Tax Shield</h3>
                        
                        <div class="input-group">
                            <label for="propertyTax" class="block text-sm font-medium text-gray-700">Property Tax ($):</label>
                            <input type="number" id="propertyTax" value="7000" min="0" step="100" class="w-full mt-1">
                        </div>
                        
                        <div class="input-group">
                            <label for="insurance" class="block text-sm font-medium text-gray-700">Homeowners Insurance ($):</label>
                            <input type="number" id="insurance" value="2500" min="0" step="100" class="w-full mt-1">
                        </div>
                        
                        <div class="input-group">
                            <label for="utilities" class="block text-sm font-medium text-gray-700">Maintenance & Repair Allowance ($):</label>
                            <input type="number" id="utilities" value="3500" min="0" step="100" class="w-full mt-1">
                            <p class="text-xs text-gray-500 mt-1">Budget for upkeep, typically 1% of home value annually.</p>
                        </div>

                        <div class="input-group">
                            <label for="expenseGrowth" class="block text-sm font-medium text-gray-700">Annual Expense Growth (%):</label>
                            <input type="number" id="expenseGrowth" value="3.0" min="0.0" max="10.0" step="0.1" class="w-full mt-1">
                        </div>
                        
                        <div class="input-group">
                            <label for="marginalTaxRate" class="block text-sm font-medium text-gray-700">Marginal Tax Rate (%):</label>
                            <input type="number" id="marginalTaxRate" value="25" min="0" max="50" step="1" class="w-full mt-1">
                            <p class="text-xs text-gray-500 mt-1">Used to calculate tax savings from mortgage interest and property tax deductions.</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4 p-4 border rounded-lg bg-purple-50">
                        <h3 class="font-bold text-lg text-appreciation-purple">Holding & Exit</h3> <div class="input-group">
                            <label for="holdingPeriod" class="block text-sm font-medium text-gray-700">Holding Period (Years):</label>
                            <input type="number" id="holdingPeriod" value="7" min="5" max="40" step="1" class="w-full mt-1">
                        </div>

                        <div class="input-group">
                            <label for="costOfSale" class="block text-sm font-medium text-gray-700">Cost of Sale (% of Value):</label>
                            <input type="number" id="costOfSale" value="6.0" min="0.0" max="15.0" step="0.5" class="w-full mt-1">
                            <p class="text-xs text-gray-500 mt-1">Broker fees, closing costs, etc. applied at sale.</p>
                        </div>
                        
                        </div>
                </div>
            </div>

            <div class="p-4 sm:p-6 bg-white shadow-xl rounded-xl border border-gray-100 flex flex-col">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Equity Growth & Annualized Return (Calculated over <span id="summaryTerm">7</span> Years)</h2>
                
                <div class="chart-container flex-grow">
                    <canvas id="investmentChart"></canvas>
                </div>
                
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-2 border-b pb-1">Exit Projections & Key Metrics:</h3>
                    <div id="summaryDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Global storage for simulation results
        let simulationResults = []; 
        let cumulativeRoe = []; // Renamed IRR to ROE (Return on Equity)
        const MAX_SIMULATION_YEARS = 40; 
        
        // GLOBAL CHART VARIABLE 
        let investmentChart; 

        // --- Core Financial Model Functions ---

        /**
         * Formats a number as a currency string.
         */
        const currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });
        
        // Define Chart Colors
        const ROE_COLOR = 'rgba(249, 115, 22, 0.8)'; // irr-orange

        /**
         * Calculates the fixed monthly payment for a fully amortizing loan.
         */
        function calculateMonthlyPayment(principal, annualRate, termsInYears) {
            const monthlyRate = annualRate / 12;
            const months = termsInYears * 12;

            if (monthlyRate === 0) return principal / months;
            if (months === 0) return 0;

            const factor = Math.pow(1 + monthlyRate, months);
            return principal * (monthlyRate * factor) / (factor - 1);
        }

        /**
         * Calculates the remaining mortgage balance after 'k' payments.
         */
        function calculateRemainingBalance(principal, annualRate, termsInYears, monthsPaid) {
            const monthlyRate = annualRate / 12;
            const months = termsInYears * 12;

            if (monthsPaid >= months) return 0;
            if (monthlyRate === 0) return principal * (1 - monthsPaid / months);
            if (months === 0) return principal;

            const factorN = Math.pow(1 + monthlyRate, months);
            const factorK = Math.pow(1 + monthlyRate, monthsPaid);
            
            const balance = principal * (factorN - factorK) / (factorN - 1);
            // Ensure balance is exactly 0 if fully paid
            return (balance < 1 && monthsPaid >= months) ? 0 : Math.max(0, balance); 
        }

        /**
         * Calculates the Internal Rate of Return (IRR) using Newton's method. (Used here as Return on Equity)
         */
        function calculateIRR(cashFlows) {
            if (cashFlows.length < 2) return 0;
            if (cashFlows.every(cf => cf === 0)) return 0;

            // Helper function for Net Present Value (NPV)
            const NPV = (rate) => {
                return cashFlows.reduce((sum, flow, year) => {
                    return sum + flow / Math.pow(1 + rate, year);
                }, 0);
            };

            let guess = 0.1; 
            const maxIterations = 100;
            const tolerance = 0.0001;

            for (let i = 0; i < maxIterations; i++) {
                const npv = NPV(guess);

                // Derivative of NPV (NPV')
                const derivative = cashFlows.reduce((sum, flow, year) => {
                    return sum - flow * year / Math.pow(1 + guess, year + 1);
                }, 0);

                if (Math.abs(derivative) < 1e-6) {
                    guess += 0.001; 
                    continue;
                }

                const nextGuess = guess - npv / derivative;

                if (Math.abs(nextGuess - guess) < tolerance) {
                    return nextGuess; 
                }

                guess = nextGuess;
                
                if (Math.abs(guess) > 100) return 0; 
            }

            return 0; 
        }
        
        /**
         * REMOVED: Calculates the future value (FV) of the initial investment at the opportunity cost rate.
         
        function calculateOpportunityCost(initialInvestment, opportunityRate, years) {
            return initialInvestment * Math.pow(1 + opportunityRate, years);
        }
        */

        /**
         * Retrieves current input parameters from the controls.
         */
        function getParams() {
            const P = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const DP_PCT = parseFloat(document.getElementById('downPayment').value) / 100 || 0;
            const LOAN_TERM_YRS = parseInt(document.getElementById('loanTerm').value) || 30;
            
            const LOAN = P * (1 - DP_PCT);

            const monthlyPmt = calculateMonthlyPayment(
                LOAN, 
                parseFloat(document.getElementById('interestRate').value) / 100 || 0.07, 
                LOAN_TERM_YRS
            );

            // Calculate initial investment (Down Payment only for simplicity, excluding closing costs)
            const INITIAL_INVESTMENT = P * DP_PCT;

            return {
                P: P,
                INITIAL_INVESTMENT: INITIAL_INVESTMENT,
                LOAN_PRINCIPAL: LOAN,
                
                RATE: parseFloat(document.getElementById('interestRate').value) / 100 || 0.065,
                PMI_MONTHLY: (DP_PCT < 0.20 && DP_PCT > 0) ? parseFloat(document.getElementById('pmi').value) : 0,
                LOAN_TERM_YRS: LOAN_TERM_YRS,
                MONTHLY_PMT: monthlyPmt, 
                
                APPRECIATION_RATE: parseFloat(document.getElementById('appreciation').value) / 100 || 0.04,

                TAX_0: parseFloat(document.getElementById('propertyTax').value) || 0,
                INSURANCE_0: parseFloat(document.getElementById('insurance').value) || 0,
                MAINTENANCE_0: parseFloat(document.getElementById('utilities').value) || 0, // Renamed 'utilities' to 'maintenance'
                EXPENSE_GROWTH: parseFloat(document.getElementById('expenseGrowth').value) / 100 || 0.03,

                MARGINAL_TAX_RATE: parseFloat(document.getElementById('marginalTaxRate').value) / 100 || 0.25,
                
                HOLDING_PERIOD: parseInt(document.getElementById('holdingPeriod').value) || 7,
                COST_OF_SALE_PCT: parseFloat(document.getElementById('costOfSale').value) / 100 || 0.06,
                // REMOVED: OPPORTUNITY_RATE: parseFloat(document.getElementById('opportunityCostRate').value) / 100 || 0.08,
            };
        }

        /**
         * Main calculation engine. Simulates the SFH ownership year-by-year.
         */
        function calculateSFHOwnership(params) {
            const SIMULATION_YEARS = Math.min(params.HOLDING_PERIOD, MAX_SIMULATION_YEARS);
            
            const results = [];
            let cumulativeNetCost = 0; 
            const loanPrincipal = params.LOAN_PRINCIPAL;
            
            const monthlyPmt = params.MONTHLY_PMT;
            const annualDebtService = monthlyPmt * 12; // P + I
            const annualPMI = params.PMI_MONTHLY * 12;
            
            // Year 0 Initialization (T=0)
            results.push({
                year: 0,
                propertyValue: params.P,
                mortgageBalance: loanPrincipal,
                initialEquity: params.INITIAL_INVESTMENT,
                paydown: 0,
                appreciation: 0,
                taxShield: 0,
                annualNetCost: 0, 
                cumulativeNetCost: 0, 
                totalAnnualCashFlow: -params.INITIAL_INVESTMENT // CF0 is initial investment (negative)
            });
            
            // Simulation Loop
            for (let t = 1; t <= SIMULATION_YEARS; t++) {
                
                // 1. Property Value & Debt
                const propertyValue = params.P * Math.pow(1 + params.APPRECIATION_RATE, t);
                const appreciation = propertyValue - params.P;

                const monthsPaid = t * 12;
                const remainingBalance = calculateRemainingBalance(
                    loanPrincipal, 
                    params.RATE, 
                    params.LOAN_TERM_YRS, 
                    monthsPaid
                );
                const paydown = loanPrincipal - remainingBalance;

                const balStartYear = calculateRemainingBalance(loanPrincipal, params.RATE, params.LOAN_TERM_YRS, (t - 1) * 12);
                const totalAmortization = balStartYear - remainingBalance;
                const annualInterestPaid = annualDebtService - totalAmortization; // I only
                
                // 2. Expenses
                const taxT = params.TAX_0 * Math.pow(1 + params.EXPENSE_GROWTH, t - 1);
                const insuranceT = params.INSURANCE_0 * Math.pow(1 + params.EXPENSE_GROWTH, t - 1);
                const maintenanceT = params.MAINTENANCE_0 * Math.pow(1 + params.EXPENSE_GROWTH, t - 1);
                
                let currentPMI = 0;
                // PMI drops off when LTV hits 80%
                if (params.PMI_MONTHLY > 0 && remainingBalance / propertyValue > 0.8) {
                    currentPMI = annualPMI;
                }
                
                const totalOperatingExpenses = taxT + insuranceT + maintenanceT + currentPMI;

                // 3. Tax Shield (Deductions: Interest + Property Tax)
                // Assuming itemization and deduction limits are met.
                const deductibleItems = annualInterestPaid + taxT;
                const taxShield = deductibleItems * params.MARGINAL_TAX_RATE;

                // 4. *** THE CRITICAL FIX: Net Annual Cost (Consumed Cost) ***
                // This is the cash outflow that is NOT returned (Interest + Ops + PMI) - Tax Shield.
                // It EXCLUDES the Principal portion of the P&I payment.
                const consumedAnnualCostBeforeTax = annualInterestPaid + totalOperatingExpenses; 
                const annualNetCost = consumedAnnualCostBeforeTax - taxShield;
                
                cumulativeNetCost += annualNetCost;

                // 5. Total Annual Cash Flow (for ROE calculation)
                // This is the net cash outlay, which is always negative for a primary residence's "consumed cost"
                const totalAnnualCashFlow = -annualNetCost; // CF_t = -(Consumed Cost)

                results.push({
                    year: t,
                    propertyValue: propertyValue,
                    mortgageBalance: remainingBalance,
                    initialEquity: params.INITIAL_INVESTMENT,
                    paydown: paydown,
                    appreciation: appreciation,
                    taxShield: taxShield, 
                    annualNetCost: annualNetCost,
                    cumulativeNetCost: cumulativeNetCost,
                    totalAnnualCashFlow: totalAnnualCashFlow,
                });
            }

            return results;
        }

        /**
         * Prepares data for the chart, including stacking data and ROE calculation.
         */
        function prepareChartData(results, params) {
            const SIMULATION_YEARS = results.length - 1; 
            const labels = results.map(r => r.year);
            
            // Stacking Data: Equity Components only
            const initialEquityData = results.map(r => params.INITIAL_INVESTMENT); 
            const paydownData = results.map(r => r.paydown); 
            const appreciationData = results.map(r => r.appreciation); 
            
            // --- ROE CALCULATION (Using IRR logic) ---
            
            let roeCashFlows = [results[0].totalAnnualCashFlow]; // CF0 is initial investment (negative)
            cumulativeRoe = [0]; 

            for (let t = 1; t <= SIMULATION_YEARS; t++) {
                const result = results[t];

                // 1. Get the actual annual net cash flow (consumed cost) for year t
                const annualCF = result.totalAnnualCashFlow; 
                
                roeCashFlows.push(annualCF); 

                // --- Temporary modification for ROE calculation at year t (ASSUMED Sale Event) ---
                
                // Calculate Net Sales Proceeds IF the property was sold at Year t
                const finalPropertyValue = result.propertyValue;
                const costOfSaleAmount = finalPropertyValue * params.COST_OF_SALE_PCT;
                const netSalesProceeds = finalPropertyValue - costOfSaleAmount;
                const netCashOutAfterDebt = netSalesProceeds - result.mortgageBalance; // Positive Cash Out
                
                // The cash flow for the assumed exit year (t) must include the net sale proceeds
                // CF_Exit = Annual_Consumed_Cost + Net_Sale_Proceeds
                const cashFlowAtExit = annualCF + netCashOutAfterDebt; 
                
                // Temporarily replace the last element (which is annualCF) with the cashFlowAtExit
                const originalLastCF = roeCashFlows[t];
                roeCashFlows[t] = cashFlowAtExit; 
                
                // 3. Calculate the ROE for the full stream CF0, CF1, ..., CF(t-1), [CF(t) + Sale]
                const currentROE = calculateIRR(roeCashFlows);
                cumulativeRoe.push(currentROE * 100); 

                // 4. Restore the last element to the original annual cash flow (CFt) 
                if (t < params.HOLDING_PERIOD) {
                    roeCashFlows[t] = originalLastCF;
                }
            }

            // --- Datasets for Chart.js ---
            return {
                labels: labels,
                datasets: [
                    // Stacked Equity/Value Components (Y-axis: Left)
                    {
                        label: 'Initial Equity (Down Payment)',
                        data: initialEquityData,
                        backgroundColor: 'rgba(250, 202, 21, 0.7)', // equity-yellow
                        fill: true,
                        order: 3,
                        stack: 'Stack 0',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Mortgage Paydown (Amortization)',
                        data: paydownData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)', // paydown-blue
                        fill: true,
                        order: 2,
                        stack: 'Stack 0',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Cumulative Appreciation',
                        data: appreciationData,
                        backgroundColor: 'rgba(139, 92, 246, 0.7)', // appreciation-purple
                        fill: true,
                        order: 1,
                        stack: 'Stack 0',
                        yAxisID: 'y'
                    },
                    // ROE Line (Y-axis: Right)
                    {
                        label: 'Annualized Return on Equity (ROE %)',
                        data: cumulativeRoe,
                        backgroundColor: ROE_COLOR, 
                        borderColor: ROE_COLOR,
                        yAxisID: 'y1', 
                        type: 'line', 
                        fill: false,
                        pointRadius: 3,
                        pointBackgroundColor: ROE_COLOR,
                        order: 0, // Draw on top of stacked area
                    }
                ]
            };
        }

        /**
         * Initializes the Chart.js graph.
         */
        function initializeChart(chartData, params) {
            const ctx = document.getElementById('investmentChart').getContext('2d');
            
            if (typeof ChartjsPluginAnnotation !== 'undefined') {
                Chart.register(ChartjsPluginAnnotation);
            }
            
            investmentChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y') {
                                        label += currencyFormatter.format(context.parsed.y);
                                    } else {
                                        label += context.parsed.y.toFixed(2) + '%';
                                    }
                                    return label;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Equity Accumulation and Rate of Return on Equity',
                            font: { size: 16 }
                        },
                        annotation: {
                            annotations: {
                                holdingPeriodLine: {
                                    type: 'line',
                                    mode: 'vertical',
                                    scaleID: 'x',
                                    value: params.HOLDING_PERIOD,
                                    borderColor: 'rgba(239, 68, 68, 0.8)', // cost-red
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        content: `Exit Year (${params.HOLDING_PERIOD} Yrs)`,
                                        display: true,
                                        position: 'top',
                                        backgroundColor: 'rgba(239, 68, 68, 0.9)',
                                        color: '#fff',
                                        font: { size: 12, weight: 'bold' },
                                        padding: 6
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Year of Ownership',
                                font: { weight: 'bold' }
                            },
                            ticks: {
                                callback: (value, index) => chartData.labels[index]
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Accumulated Equity Value ($)',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 0) {
                                        return currencyFormatter.format(value);
                                    }
                                    return '';
                                }
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Annualized ROE (%)',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                drawOnChartArea: false, 
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Updates the chart with new data.
         */
        function updateChart(chartData, params) {
            if (investmentChart) {
                investmentChart.data = chartData;
                
                // Update Holding Period Line Annotation
                if (investmentChart.options.plugins.annotation && investmentChart.options.plugins.annotation.annotations.holdingPeriodLine) {
                    investmentChart.options.plugins.annotation.annotations.holdingPeriodLine.value = params.HOLDING_PERIOD;
                    investmentChart.options.plugins.annotation.annotations.holdingPeriodLine.label.content = `Exit Year (${params.HOLDING_PERIOD} Yrs)`;
                }

                investmentChart.update();
            } else {
                initializeChart(chartData, params);
            }
        }

        /**
         * Generates the summary table for the exit year.
         */
        function displaySummary(results, params) {
            const H = params.HOLDING_PERIOD;
            const exitData = results[H];
            const summaryDiv = document.getElementById('summaryDisplay');
            summaryDiv.innerHTML = '';
            
            if (!exitData) {
                summaryDiv.innerHTML = '<p class="text-red-500 font-semibold">Error: Holding period exceeds simulation data.</p>';
                return;
            }

            // Calculations for Exit
            const finalPropertyValue = exitData.propertyValue;
            const costOfSaleAmount = finalPropertyValue * params.COST_OF_SALE_PCT;
            const netSalesProceeds = finalPropertyValue - costOfSaleAmount;
            const netCashOutAfterDebt = netSalesProceeds - exitData.mortgageBalance;
            
            const annualizedROE = cumulativeRoe[H] || 0;
            // REMOVED: const opportunityCostFV = calculateOpportunityCost(params.INITIAL_INVESTMENT, params.OPPORTUNITY_RATE, H);
            
            // The value of the home at purchase plus all subsequent net outlays (consumed cost)
            // Initial Investment + Sum of all Consumed Costs
            const totalOutlay = params.INITIAL_INVESTMENT + exitData.cumulativeNetCost; 
            
            const totalGain = netCashOutAfterDebt - totalOutlay;


            const summaryItems = [
                { label: 'Final Home Value', value: currencyFormatter.format(finalPropertyValue), color: 'text-primary-blue' },
                { label: 'Total Equity at Exit (before sale costs)', value: currencyFormatter.format(netSalesProceeds - exitData.mortgageBalance + costOfSaleAmount), color: 'text-appreciation-purple' },
                { label: 'Cost of Sale (' + (params.COST_OF_SALE_PCT * 100).toFixed(1) + '%)', value: '-' + currencyFormatter.format(costOfSaleAmount), color: 'text-cost-red' },
                { label: 'Remaining Mortgage Balance', value: '-' + currencyFormatter.format(exitData.mortgageBalance), color: 'text-cost-red' },
                { label: 'Net Cash Proceeds (after costs & debt)', value: currencyFormatter.format(netCashOutAfterDebt), color: 'text-equity-yellow' },
                
                { label: '---', value: '---', color: 'text-gray-400' }, // Separator
                
                { label: 'Total Initial Investment (Down Payment)', value: currencyFormatter.format(params.INITIAL_INVESTMENT), color: 'text-gray-600' },
                { label: 'Total Consumed Cost (Interest, Tax, Maint, Net of Tax Shield)', value: currencyFormatter.format(exitData.cumulativeNetCost), color: 'text-cost-red' },
                
                { label: 'Total Net Gain (Profit)', value: currencyFormatter.format(totalGain), color: totalGain >= 0 ? 'text-primary-blue' : 'text-cost-red', large: true },
                { label: 'Annualized ROE (IRR)', value: annualizedROE.toFixed(2) + '%', color: annualizedROE >= 0 ? 'text-irr-orange' : 'text-cost-red', large: true },
                
                /* REMOVED: Opportunity Cost Comparison 
                { 
                    label: 'Opportunity Cost: Initial Capital @ ' + (params.OPPORTUNITY_RATE * 100).toFixed(1) + '% FV', 
                    value: currencyFormatter.format(opportunityCostFV), 
                    color: 'text-opportunity-green', 
                    large: false
                },
                { 
                    label: 'Difference: Net Proceeds vs. Opportunity Cost FV', 
                    value: currencyFormatter.format(netCashOutAfterDebt - opportunityCostFV), 
                    color: (netCashOutAfterDebt - opportunityCostFV) >= 0 ? 'text-primary-blue' : 'text-cost-red', 
                    large: true 
                },
                */
            ];

            summaryItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `flex justify-between items-center py-1 ${item.large ? 'font-extrabold border-t border-gray-300 pt-2' : ''}`;
                
                const labelSpan = document.createElement('span');
                labelSpan.textContent = item.label;
                labelSpan.className = 'text-gray-700';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = item.value;
                valueSpan.className = `font-semibold ${item.color} ${item.large ? 'text-lg' : ''}`;

                if (item.label === '---') {
                    itemDiv.className = 'col-span-1 md:col-span-2 border-t border-gray-200 my-1';
                    itemDiv.innerHTML = '';
                } else {
                    itemDiv.appendChild(labelSpan);
                    itemDiv.appendChild(valueSpan);
                }
                
                summaryDiv.appendChild(itemDiv);
            });
            
            // Update summary term display
            document.getElementById('summaryTerm').textContent = H;
        }

        /**
         * Master function to run the simulation and update the display.
         */
        function runSimulation() {
            const params = getParams();
            // Ensure holding period is not greater than max simulation years
            params.HOLDING_PERIOD = Math.min(params.HOLDING_PERIOD, MAX_SIMULATION_YEARS); 
            
            simulationResults = calculateSFHOwnership(params);
            const chartData = prepareChartData(simulationResults, params);
            
            updateChart(chartData, params);
            displaySummary(simulationResults, params);
        }

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get all input elements inside the controls div
            const inputs = document.querySelectorAll('#controls input, #controls select');
            
            // Add a change event listener to each input
            inputs.forEach(input => {
                input.addEventListener('change', runSimulation);
                input.addEventListener('keyup', (e) => {
                    // Re-run simulation on Enter keyup for numbers, or a small delay for general inputs
                    if (e.key === 'Enter' || input.type === 'number') {
                        runSimulation();
                    }
                });
            });

            // Initial run
            runSimulation();
        });

    </script>
</body>
</html>